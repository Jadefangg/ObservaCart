{"ast":null,"code":"/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as api from '@opentelemetry/api';\nimport { isAttributeValue, hrTime, hrTimeDuration, isTimeInput, timeInputToHrTime } from '@opentelemetry/core';\nimport { SemanticAttributes } from '@opentelemetry/semantic-conventions';\nimport { ExceptionEventName } from './enums';\n/**\n * This class represents a span.\n */\nvar Span = /** @class */function () {\n  /** Constructs a new Span instance. */\n  function Span(parentTracer, context, spanName, spanContext, kind, parentSpanId, links, startTime) {\n    if (links === void 0) {\n      links = [];\n    }\n    if (startTime === void 0) {\n      startTime = hrTime();\n    }\n    this.attributes = {};\n    this.links = [];\n    this.events = [];\n    this.status = {\n      code: api.SpanStatusCode.UNSET\n    };\n    this.endTime = [0, 0];\n    this._ended = false;\n    this._duration = [-1, -1];\n    this.name = spanName;\n    this._spanContext = spanContext;\n    this.parentSpanId = parentSpanId;\n    this.kind = kind;\n    this.links = links;\n    this.startTime = timeInputToHrTime(startTime);\n    this.resource = parentTracer.resource;\n    this.instrumentationLibrary = parentTracer.instrumentationLibrary;\n    this._spanLimits = parentTracer.getSpanLimits();\n    this._spanProcessor = parentTracer.getActiveSpanProcessor();\n    this._spanProcessor.onStart(this, context);\n    this._attributeValueLengthLimit = this._spanLimits.attributeValueLengthLimit || 0;\n  }\n  Span.prototype.spanContext = function () {\n    return this._spanContext;\n  };\n  Span.prototype.setAttribute = function (key, value) {\n    if (value == null || this._isSpanEnded()) return this;\n    if (key.length === 0) {\n      api.diag.warn(\"Invalid attribute key: \" + key);\n      return this;\n    }\n    if (!isAttributeValue(value)) {\n      api.diag.warn(\"Invalid attribute value set for key: \" + key);\n      return this;\n    }\n    if (Object.keys(this.attributes).length >= this._spanLimits.attributeCountLimit && !Object.prototype.hasOwnProperty.call(this.attributes, key)) {\n      return this;\n    }\n    this.attributes[key] = this._truncateToSize(value);\n    return this;\n  };\n  Span.prototype.setAttributes = function (attributes) {\n    for (var _i = 0, _a = Object.entries(attributes); _i < _a.length; _i++) {\n      var _b = _a[_i],\n        k = _b[0],\n        v = _b[1];\n      this.setAttribute(k, v);\n    }\n    return this;\n  };\n  /**\n   *\n   * @param name Span Name\n   * @param [attributesOrStartTime] Span attributes or start time\n   *     if type is {@type TimeInput} and 3rd param is undefined\n   * @param [startTime] Specified start time for the event\n   */\n  Span.prototype.addEvent = function (name, attributesOrStartTime, startTime) {\n    if (this._isSpanEnded()) return this;\n    if (this.events.length >= this._spanLimits.eventCountLimit) {\n      api.diag.warn('Dropping extra events.');\n      this.events.shift();\n    }\n    if (isTimeInput(attributesOrStartTime)) {\n      if (typeof startTime === 'undefined') {\n        startTime = attributesOrStartTime;\n      }\n      attributesOrStartTime = undefined;\n    }\n    if (typeof startTime === 'undefined') {\n      startTime = hrTime();\n    }\n    this.events.push({\n      name: name,\n      attributes: attributesOrStartTime,\n      time: timeInputToHrTime(startTime)\n    });\n    return this;\n  };\n  Span.prototype.setStatus = function (status) {\n    if (this._isSpanEnded()) return this;\n    this.status = status;\n    return this;\n  };\n  Span.prototype.updateName = function (name) {\n    if (this._isSpanEnded()) return this;\n    this.name = name;\n    return this;\n  };\n  Span.prototype.end = function (endTime) {\n    if (endTime === void 0) {\n      endTime = hrTime();\n    }\n    if (this._isSpanEnded()) {\n      api.diag.error('You can only call end() on a span once.');\n      return;\n    }\n    this._ended = true;\n    this.endTime = timeInputToHrTime(endTime);\n    this._duration = hrTimeDuration(this.startTime, this.endTime);\n    if (this._duration[0] < 0) {\n      api.diag.warn('Inconsistent start and end time, startTime > endTime', this.startTime, this.endTime);\n    }\n    this._spanProcessor.onEnd(this);\n  };\n  Span.prototype.isRecording = function () {\n    return this._ended === false;\n  };\n  Span.prototype.recordException = function (exception, time) {\n    if (time === void 0) {\n      time = hrTime();\n    }\n    var attributes = {};\n    if (typeof exception === 'string') {\n      attributes[SemanticAttributes.EXCEPTION_MESSAGE] = exception;\n    } else if (exception) {\n      if (exception.code) {\n        attributes[SemanticAttributes.EXCEPTION_TYPE] = exception.code.toString();\n      } else if (exception.name) {\n        attributes[SemanticAttributes.EXCEPTION_TYPE] = exception.name;\n      }\n      if (exception.message) {\n        attributes[SemanticAttributes.EXCEPTION_MESSAGE] = exception.message;\n      }\n      if (exception.stack) {\n        attributes[SemanticAttributes.EXCEPTION_STACKTRACE] = exception.stack;\n      }\n    }\n    // these are minimum requirements from spec\n    if (attributes[SemanticAttributes.EXCEPTION_TYPE] || attributes[SemanticAttributes.EXCEPTION_MESSAGE]) {\n      this.addEvent(ExceptionEventName, attributes, time);\n    } else {\n      api.diag.warn(\"Failed to record an exception \" + exception);\n    }\n  };\n  Object.defineProperty(Span.prototype, \"duration\", {\n    get: function () {\n      return this._duration;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(Span.prototype, \"ended\", {\n    get: function () {\n      return this._ended;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Span.prototype._isSpanEnded = function () {\n    if (this._ended) {\n      api.diag.warn(\"Can not execute the operation on ended Span {traceId: \" + this._spanContext.traceId + \", spanId: \" + this._spanContext.spanId + \"}\");\n    }\n    return this._ended;\n  };\n  // Utility function to truncate given value within size\n  // for value type of string, will truncate to given limit\n  // for type of non-string, will return same value\n  Span.prototype._truncateToLimitUtil = function (value, limit) {\n    if (value.length <= limit) {\n      return value;\n    }\n    return value.substr(0, limit);\n  };\n  /**\n   * If the given attribute value is of type string and has more characters than given {@code attributeValueLengthLimit} then\n   * return string with trucated to {@code attributeValueLengthLimit} characters\n   *\n   * If the given attribute value is array of strings then\n   * return new array of strings with each element truncated to {@code attributeValueLengthLimit} characters\n   *\n   * Otherwise return same Attribute {@code value}\n   *\n   * @param value Attribute value\n   * @returns truncated attribute value if required, otherwise same value\n   */\n  Span.prototype._truncateToSize = function (value) {\n    var _this = this;\n    var limit = this._attributeValueLengthLimit;\n    // Check limit\n    if (limit <= 0) {\n      // Negative values are invalid, so do not truncate\n      api.diag.warn(\"Attribute value limit must be positive, got \" + limit);\n      return value;\n    }\n    // String\n    if (typeof value === 'string') {\n      return this._truncateToLimitUtil(value, limit);\n    }\n    // Array of strings\n    if (Array.isArray(value)) {\n      return value.map(function (val) {\n        return typeof val === 'string' ? _this._truncateToLimitUtil(val, limit) : val;\n      });\n    }\n    // Other types, no need to apply value length limit\n    return value;\n  };\n  return Span;\n}();\nexport { Span };","map":{"version":3,"names":["api","isAttributeValue","hrTime","hrTimeDuration","isTimeInput","timeInputToHrTime","SemanticAttributes","ExceptionEventName","Span","parentTracer","context","spanName","spanContext","kind","parentSpanId","links","startTime","attributes","events","status","code","SpanStatusCode","UNSET","endTime","_ended","_duration","name","_spanContext","resource","instrumentationLibrary","_spanLimits","getSpanLimits","_spanProcessor","getActiveSpanProcessor","onStart","_attributeValueLengthLimit","attributeValueLengthLimit","prototype","setAttribute","key","value","_isSpanEnded","length","diag","warn","Object","keys","attributeCountLimit","hasOwnProperty","call","_truncateToSize","setAttributes","_i","_a","entries","_b","k","v","addEvent","attributesOrStartTime","eventCountLimit","shift","undefined","push","time","setStatus","updateName","end","error","onEnd","isRecording","recordException","exception","EXCEPTION_MESSAGE","EXCEPTION_TYPE","toString","message","stack","EXCEPTION_STACKTRACE","defineProperty","get","traceId","spanId","_truncateToLimitUtil","limit","substr","_this","Array","isArray","map","val"],"sources":["../../src/Span.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}